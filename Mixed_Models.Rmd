---
title: "Mixed Models"
author: "Pedro Victor Brasil Ribeiro"
date: "2021-11-22 - Last changed in `r Sys.Date()`"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{bm}
   - \usepackage{multirow}
   - \usepackage{float}
output: pdf_document
---

```{r setup, include=FALSE}
library(usethis)
library(tidyverse)
library(bbmle)
library(magrittr)
library(lme4)
library(nlme)
library(kableExtra)
dados <- read_table2("https://raw.githubusercontent.com/ranalytics/r-tutorials/master/Edition_2015/Data/RIKZ.txt")
```

# Longitudinal Data

Longitudinal data, also called as panel data, is data that is collected through a series of repeated observations of the same subject overtime. Longitudinal experiments planning concern the observation of one or more variables in the same subject on different ocassions or condicion of evaluation, time is a commom factor used in most of experiment, but it can be use on distances among other factors, but in the present work it will be implied that the subjects measures is taken over time.

Given that longitudinal data are measures of the same subject taken in a systematic way, is expected not null correlations between the measures, especially the one taken in consecutive. Furthermore is expected heterocedasticidy.

About the data structure is expected 3 characteristics, but have in mind that in a real experiement ambient, not necessarily those characteristics can actually be hold:

\begin{itemize}
  \item Regular (in respect to time): The interval of time between one measure and other are the same;
  \item Balanced (in respect to time): All observations are taken in the same time, on the same condictions in all subjects;
  \item Complete: No lost observations.
\end{itemize}

\begin{table}[H]
\centering
\caption{Basic structure of balanced and complete longitudinal data}
\label{tab1}
\begin{tabular}{cccccc}
\hline
\multirow{2}{*}{Grupo ou Tratamento} & \multirow{2}{*}{Unidade Experimental} & \multicolumn{4}{c}{Condições de Avaliação} \\ \cline{3-6} 
                   &           &  1           & 2           & $\cdots$  & t           \\ \hline
\multirow{4}{*}{1} &  1        &  $y_{111}$   & $y_{112}$   & $\cdots$  & $y_{11t}$   \\
                   &  2        &  $y_{121}$   & $y_{122}$   & $\cdots$  & $y_{12t}$   \\
                   &  $\vdots$ &  $\vdots$    & $\vdots$    & $\ddots$  & $\vdots$    \\
                   &  $n_1$    &  $y_{1n_11}$ & $y_{1n_12}$ & $\cdots$  & $y_{1n_1t}$ \\ \hline
\multirow{4}{*}{2} &  1        &  $y_{211}$   & $y_{212}$   & $\cdots$  & $y_{21t}$   \\
                   &  2        &  $y_{221}$   & $y_{222}$   & $\cdots$  & $y_{22t}$   \\
                   &  $\vdots$ &  $\vdots$    & $\vdots$    & $\ddots$  & $\vdots$    \\
                   &  $n_2$    &  $y_{2n_21}$ & $y_{2n_22}$ & $\cdots$  & $y_{2n_2t}$ \\ \hline
$\vdots$           &  $\vdots$ &  $\vdots$    & $\vdots$    & $\vdots$  & $\vdots$    \\ \hline
\multirow{4}{*}{g} &  1        &  $y_{g11}$   & $y_{g12}$   & $\cdots$  & $y_{g1t}$   \\
                   &  2        &  $y_{g21}$   & $y_{g22}$   & $\cdots$  & $y_{g2t}$   \\
                   &  $\vdots$ &  $\vdots$    & $\vdots$    & $\vdots$  & $\vdots$    \\
                   &  $n_g$    &  $y_{gn_g1}$ & $y_{gn_g2}$ & $\cdots$  & $y_{gn_gt}$ \\ \hline
\end{tabular}
\end{table}

# Mixed Model

For the analysis of longitudinal data to take into account the correlation between measurements taken in the same experimental unit, the adjustment of regression models with the inclusion of random effects can be considered, and it's oftenly used in these kind of cases. The usual models are:

\begin{itemize}
  \item Linear Mixed Models;
  \item Generalized Linear Mixed Models;
  \item Non-Linear Mixed Models.
\end{itemize}

In this we will speak specifically about Linear Mixed Models (LMM) since is the most common model used in this kind of situation. So we'll use LMM to fit the mean profile of the subjects.

As usually done in Linear Models, the LMM is use to make the inference on the populacional mean of the populacion, but in the LMM is used the y conditioned in u, in other words E[Y|u]. For a LMM $X\beta$ represent the fixed effects, but is added a random effect represented by Zu, where just as X is the knew model matriz, and u the random variables used to define the condicional model, expressed as:

\begin{equation}
  E[Y|u] = X\beta + Zu + \varepsilon \label{eq}
\end{equation}

Where from the model \ref{eq} is usually assumed that $b_i \sim N_q(0,G)$ and $\varepsilon \sim N_{m_i}(0,R_i)$, where $m_i$ is the number of instants that the subject is measured.

\begin{table}[H]
\centering
\caption{Summary of the dimensions of each component}
\label{tab1}
\begin{tabular}{lc}
\hline
Componente & Dimensão          \\ \hline
y             & $N \times 1$   \\
X             & $N \times p$   \\
$\beta$       & $p \times 1$   \\
Z             & $N \times nq$  \\
b             & $nq \times 1$  \\
$\varepsilon$ & $N \times 1$   \\
$\Gamma$      & $nq \times nq$ \\
R             & $N \times N$   \\
$\Omega$      & $N \times N$   \\
$\theta$      & $t \times t$   \\ \hline
\end{tabular}
\end{table}

WHere in a more techinicall manner the modelo \ref{eq}, which $y = [ y_1^T, \cdots , y_n^T ] (N \times 1)$, with  $N = \sum_{i = 1}^n n_i$, have the fixed part and the random part, the parameter of the model can be write in a matter where $b \sim N_{nq}(0, \Gamma(\theta))$, where $\Gamma(\theta) = I_n \otimes G(\theta)$ is independent of $\varepsilon \sim N_N(0,R(\theta)), R(\theta) = \otimes_{i = 1}^n R_i(\theta)$, with give the final distribuition of y as $y \sim N_N(X\beta,\Omega(\theta))$, where $\Omega(\theta) = Z\Gamma(\theta)Z^T + R(\theta)$.

Which show us that the fixed effect affect only the mean of y, when the random affect affect the variance of y.

# Structure of the covariance

The greater part of the effort of fit a Mixed Linear Model is to choose the structure of the covariance, which greatly affect the goodness-of-fit of the fitted model.

Theorically speaking those structure can be used on $\Omega(\theta), R(\theta)$ and $G(\theta)$, but is usually used in the variance of y ($\Omega(\theta)$).

Some exemples of covariante structure, considering $n_i = 4$:

## Uniform structure
[$\theta = (\sigma^2,\tau)^T$]

\begin{center}
  $\begin{bmatrix}
   \sigma^2 + \tau & \tau & \tau & \tau \\ 
   \tau & \sigma^2 + \tau & \tau & \tau \\ 
   \tau & \tau & \sigma^2 + \tau & \tau \\ 
   \tau & \tau & \tau & \sigma^2 + \tau
  \end{bmatrix}$
\end{center}

## AR(1) structure
[$\theta = (\sigma^2, \phi)^T$]

\begin{center}
  $\begin{bmatrix}
   1      & \phi   & \phi^2 & \phi^3 \\ 
   \phi   & 1      & \phi   & \phi^2 \\ 
   \phi^2 & \phi   & 1      & \phi \\ 
   \phi^3 & \phi^2 & \phi   & 1
  \end{bmatrix}$
\end{center}

## ARMA(1,1) structure
[$\theta = (\sigma^2,\phi, \gamma)^T$]

\begin{center}
  $\begin{bmatrix}
   1            & \gamma     & \phi\gamma & \gamma\phi^2 \\ 
   \gamma       & 1          & \gamma     & \gamma\phi \\ 
   \gamma\phi   & \gamma     & 1          & \gamma \\ 
   \gamma\phi^2 & \gamma\phi & \gamma     & 1
  \end{bmatrix}$
\end{center}

## Antidependence structure of 1st order
[$\theta = (\sigma_1^2, \sigma_2^2, \sigma_3^2, \sigma_4^2, \rho_1, \rho_2, \rho_3, \rho_4)^T$]

\begin{center}
  $\begin{bmatrix}
   \sigma_1^2            & \sigma_1\sigma_2\rho_1     & \sigma_1\sigma_3\rho_1\rho_2 & \sigma_1\sigma_4\rho_1\rho_2\rho_3 \\ 
   \sigma_1\sigma_2\rho_1       & \sigma_2^2          & \sigma_2\sigma_3\rho_2     & \sigma_2\sigma_4\rho_2\rho_3 \\ 
   \sigma_1\sigma_3\rho_1\rho_2   & \sigma_2\sigma_3\rho_2     & \sigma_3^2          & \sigma_3\sigma_4\rho_3 \\ 
   \sigma_1\sigma_4\rho_1\rho_2\rho_3 & \sigma_2\sigma_4\rho_2\rho_3 & \sigma_3\sigma_4\rho_3     & \sigma_4^2
  \end{bmatrix}$
\end{center}

## Toeplitz structure
[$\theta = (\sigma^2, \sigma_1, \sigma_2, \sigma_3)^T$]

\begin{center}
  $\begin{bmatrix}
   \sigma^2 & \sigma_1 & \sigma_2 & \sigma_3 \\ 
   \sigma_1 & \sigma^2 & \sigma_1 & \sigma_2 \\ 
   \sigma_2 & \sigma_1 & \sigma^2 & \sigma_1 \\ 
   \sigma_3 & \sigma_2 & \sigma_1 & \sigma^2
  \end{bmatrix}$
\end{center}

## Hetorogenally uniform structure
[$\theta = (\sigma_1^2, \sigma_2^2, \sigma_3^2, \sigma_4^2, \rho)^T$]

\begin{center}
  $\begin{bmatrix}
   \sigma_1^2           & \sigma_1\sigma_2\rho & \sigma_1\sigma_3\rho & \sigma_1\sigma_4\rho \\ 
   \sigma_2\sigma_1\rho & \sigma_2^2           & \sigma_2\sigma_3\rho & \sigma_2\sigma_4\rho \\ 
   \sigma_3\sigma_1\rho & \sigma_3\sigma_2\rho & \sigma_3^2           & \sigma_3\sigma_4\rho \\ 
   \sigma_4\sigma_1\rho & \sigma_4\sigma_2\rho & \sigma_4\sigma_3\rho & \sigma_4^2
  \end{bmatrix}$
\end{center}

## Not structured
[$\theta = (\sigma_1^2, \sigma_2^2, \sigma_3^2, \sigma_4^2, \sigma_{12}, \sigma_{13}, \sigma_{14}, \sigma_{23}, \sigma_{24}, \sigma_{34})^T$]

\begin{center}
  $\begin{bmatrix}
   \sigma_1^2  & \sigma_{12} & \sigma_{13} & \sigma_{14} \\ 
   \sigma_{12} & \sigma_2^2  & \sigma_{23} & \sigma_{24} \\ 
   \sigma_{13} & \sigma_{23} & \sigma_3^2  & \sigma_{34} \\ 
   \sigma_{14} & \sigma_{24} & \sigma_{34} & \sigma_4^2
  \end{bmatrix}$
\end{center}

# Dados Dieta - Frango

```{r}
data("ChickWeight")

frango <- groupedData(
  weight~Time|Chick, outer = ~Diet, data = ChickWeight,
  order.groups = F,
  labels=list(x="tempo (semana)", y="Peso corporal (g)")
)

plot(frango,between = list(y = c(0, 0.5, 0)))

plot(frango, outer = T, key=FALSE) # key omite a legenda

interaction.plot(frango$Time,frango$Diet,frango$weight,ylab="Peso (g)", xlab="Tempo (semana)")
```

Por tanto podemos observar que os perfis individuais apresentados para cada frango diferem entre si, apresentando um perfil médio o qual apresenta uma clara modificação na variância, quando observado o peso em relação ao tempo, perfil o qual, varia de acordo com cada dieta utilizada.


```{r}
mod1 <- lme(
  fixed = weight~Time+Diet+Time:Diet,
  random = ~1,
  data = frango,
  control = lmeControl(opt="optim")
)
mod2 <- lme(
  fixed = weight~Time+Diet+Time:Diet,
  random = ~ Diet,
  data = frango,
  control = lmeControl(opt="optim")
)
mod3 <- lme(
  fixed = weight~Time+Diet+Time:Diet,
  random = ~Time,
  data = frango,
  control = lmeControl(opt="optim")
)
mod4 <- lme(
  fixed = weight~Time+Diet+Time:Diet,
  random = ~Time + Diet,
  data = frango,
  control = lmeControl(opt="optim")
)
mod5 <- lme(
  fixed = weight~Time+Diet+Time:Diet,
  random = ~Time + Diet + Time:Diet,
  data = frango,
  control = lmeControl(opt="optim")
)
```

```{r, results = 'asis'}
coef(mod3) %>%
  as_tibble() %>%
  kable(format = "latex", booktabs = TRUE)
```




